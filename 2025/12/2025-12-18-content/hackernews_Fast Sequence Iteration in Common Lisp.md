---
source: hackernews
title: Fast Sequence Iteration in Common Lisp
url: https://world-playground-deceit.net/blog/2025/12/fast-sequence-iteration-in-common-lisp.html
date: 2025-12-18
---

[![World Playground Deceit.net](/resources/title.svg)](/)

[x] Blog

[New Posts](/blog/new-posts.xml)

[x] 2025

[x] 12

[x] [Fast SEQUENCE iteration in Common Lisp](/blog/2025/12/fast-sequence-iteration-in-common-lisp.html "Fast SEQUENCE iteration in Common Lisp")

[Introduction and code](/blog/2025/12/fast-sequence-iteration-in-common-lisp.html#h2-0)

[Benchmarks](/blog/2025/12/fast-sequence-iteration-in-common-lisp.html#h2-1)

[Conclusion](/blog/2025/12/fast-sequence-iteration-in-common-lisp.html#h2-2)

[ ] 11

[Music review: Katatonia - Dance of December Souls (1993)](/blog/2025/11/music-review-katatonia-dance-of-december-souls-1993-.html "Music review: Katatonia - Dance of December Souls (1993)")

[Function tracing in Common Lisp](/blog/2025/11/function-tracing-in-common-lisp.html "Function tracing in Common Lisp")

[Code golfing FizzBuzz in 88 bytes of C](/blog/2025/11/code-golfing-fizzbuzz-in-88-bytes-of-c.html "Code golfing FizzBuzz in 88 bytes of C")

[Novel review: Alain Damasio - La Horde du Contrevent (2004)](/blog/2025/11/novel-review-alain-damasio-la-horde-du-contrevent-2004-.html "Novel review: Alain Damasio - La Horde du Contrevent (2004)")

[Movie review: M (1931)](/blog/2025/11/movie-review-m-1931-.html "Movie review: M (1931)")

[Music review: Joy Division - Unknown Pleasures (1979)](/blog/2025/11/music-review-joy-division-unknown-pleasures-1979-.html "Music review: Joy Division - Unknown Pleasures (1979)")

[Movie review: Dark Water (2002)](/blog/2025/11/movie-review-dark-water-2002-.html "Movie review: Dark Water (2002)")

[ ] 10

[Music review: Have a Nice Life - Deathconsciousness (2008)](/blog/2025/10/music-review-have-a-nice-life-deathconsciousness-2008-.html "Music review: Have a Nice Life - Deathconsciousness (2008)")

[Novel review: Arkady & Boris Strugatsky - Roadside Picnic (1972)](/blog/2025/10/novel-review-arkady-boris-strugatsky-roadside-picnic-1972-.html "Novel review: Arkady & Boris Strugatsky - Roadside Picnic (1972)")

[Anime review: New Panty & Stocking with Garterbelt (2025)](/blog/2025/10/anime-review-new-panty-stocking-with-garterbelt-2025-.html "Anime review: New Panty & Stocking with Garterbelt (2025)")

[Movie review: Event Horizon (1997)](/blog/2025/10/movie-review-event-horizon-1997-.html "Movie review: Event Horizon (1997)")

[Novel review: Joe Abercrombie - The First Law (2006-2008)](/blog/2025/10/novel-review-joe-abercrombie-the-first-law-2006-2008-.html "Novel review: Joe Abercrombie - The First Law (2006-2008)")

[Movie review: Stalker (1979)](/blog/2025/10/movie-review-stalker-1979-.html "Movie review: Stalker (1979)")

[ ] 09

[Local Japanese culture festival haul](/blog/2025/09/local-japanese-culture-festival-haul.html "Local Japanese culture festival haul")

[Music review: Gorguts - Obscura (1998)](/blog/2025/09/music-review-gorguts-obscura-1998-.html "Music review: Gorguts - Obscura (1998)")

[Anime review: Katanagatari (2010)](/blog/2025/09/anime-review-katanagatari-2010-.html "Anime review: Katanagatari (2010)")

[Music review: Depeche Mode - Black Celebration (1986)](/blog/2025/09/music-review-depeche-mode-black-celebration-1986-.html "Music review: Depeche Mode - Black Celebration (1986)")

[ ] 08

[Novel review: Stanisław Lem - Solaris (1961)](/blog/2025/08/novel-review-stanis-aw-lem-solaris-1961-.html "Novel review: Stanisław Lem - Solaris (1961)")

[Music review: Godkiller - The End of the World (1998)](/blog/2025/08/music-review-godkiller-the-end-of-the-world-1998-.html "Music review: Godkiller - The End of the World (1998)")

[Anime review: Spriggan (1998)](/blog/2025/08/anime-review-spriggan-1998-.html "Anime review: Spriggan (1998)")

[Movie review: The Running Man (1987)](/blog/2025/08/movie-review-the-running-man-1987-.html "Movie review: The Running Man (1987)")

[Music review: Burzum - Burzum (1992)](/blog/2025/08/music-review-burzum-burzum-1992-.html "Music review: Burzum - Burzum (1992)")

[Movie review: A History of Violence (2005)](/blog/2025/08/movie-review-a-history-of-violence-2005-.html "Movie review: A History of Violence (2005)")

[Anime review: Psycho-Pass (2012)](/blog/2025/08/anime-review-psycho-pass-2012-.html "Anime review: Psycho-Pass (2012)")

[Movie review: Faust (1994)](/blog/2025/08/movie-review-faust-1994-.html "Movie review: Faust (1994)")

[Novel review: Jean-Philippe Jaworsky - Même pas mort (2013)](/blog/2025/08/novel-review-jean-philippe-jaworsky-meme-pas-mort-2013-.html "Novel review: Jean-Philippe Jaworsky - Même pas mort (2013)")

[Music review: Acid Bath - Demos: 1993-1996 (2005)](/blog/2025/08/music-review-acid-bath-demos-1993-1996-2005-.html "Music review: Acid Bath - Demos: 1993-1996 (2005)")

[Music review: Godflesh - Slavestate (1991)](/blog/2025/08/music-review-godflesh-slavestate-1991-.html "Music review: Godflesh - Slavestate (1991)")

[Compilation speed of CL implementations](/blog/2025/08/compilation-speed-of-cl-implementations.html "Compilation speed of CL implementations")

[fio-crystaldiskbenchmark](/blog/2025/08/fio-crystaldiskbenchmark.html "fio-crystaldiskbenchmark")

[ ] 07

[Emacs htmlize as batch script](/blog/2025/07/emacs-htmlize-as-batch-script.html "Emacs htmlize as batch script")

[Why "spinml"](/blog/2025/07/why-spinml-.html "Why \"spinml\"")

[Music review: Foetus - Nail (1985)](/blog/2025/07/music-review-foetus-nail-1985-.html "Music review: Foetus - Nail (1985)")

[Music review: Eyehategod - Dopesick (1996)](/blog/2025/07/music-review-eyehategod-dopesick-1996-.html "Music review: Eyehategod - Dopesick (1996)")

[Music review: Electric Wizard - Dopethrone (2000)](/blog/2025/07/music-review-electric-wizard-dopethrone-2000-.html "Music review: Electric Wizard - Dopethrone (2000)")

[X11 record and replay](/blog/2025/07/x11-record-and-replay.html "X11 record and replay")

[ ] 06

[Local art fair](/blog/2025/06/local-art-fair.html "Local art fair")

[Novel review: Robert W. Chambers - The King in Yellow (1895)](/blog/2025/06/novel-review-robert-w-chambers-the-king-in-yellow-1895-.html "Novel review: Robert W. Chambers - The King in Yellow (1895)")

[Making of a 88x31 button](/blog/2025/06/making-of-a-88x31-button.html "Making of a 88x31 button")

[Movie review: HANA-BI (1997)](/blog/2025/06/movie-review-hana-bi-1997-.html "Movie review: HANA-BI (1997)")

[Music review: Dystopia - Human = Garbage (1994)](/blog/2025/06/music-review-dystopia-human-garbage-1994-.html "Music review: Dystopia - Human = Garbage (1994)")

[Music review: Dødheimsgard - 666 International (1999)](/blog/2025/06/music-review-d-dheimsgard-666-international-1999-.html "Music review: Dødheimsgard - 666 International (1999)")

[A bubblewrap wrapper](/blog/2025/06/a-bubblewrap-wrapper.html "A bubblewrap wrapper")

[ ] [NAS setup logbook](/blog/2025/06/nas-setup-logbook.html "NAS setup logbook")

[Hardware](/blog/2025/06/nas-setup-logbook.html#h2-0)

[Topology and filesystem](/blog/2025/06/nas-setup-logbook.html#h2-1)

[Step by step](/blog/2025/06/nas-setup-logbook.html#h2-2)

[Omake 1: NFS](/blog/2025/06/nas-setup-logbook.html#h2-3)

[Omake 2: lf](/blog/2025/06/nas-setup-logbook.html#h2-4)

[A productive week-end update](/blog/2025/06/a-productive-week-end.html "A productive week-end update")

[ ] 05

[Novel review: S.M. Stirling - The Stone Dogs (1990)](/blog/2025/05/novel-review-sm-stirling-the-stone-dogs-1990-.html "Novel review: S.M. Stirling - The Stone Dogs (1990)")

[ ] [Small Pyrenees trip](/blog/2025/05/small-pyrenees-trip.html "Small Pyrenees trip")

[The trip](/blog/2025/05/small-pyrenees-trip.html#h2-0)

[A few photos](/blog/2025/05/small-pyrenees-trip.html#h2-1)

[Addendum: unexpected comeback "presents"](/blog/2025/05/small-pyrenees-trip.html#h2-2)

[Music review: Down - NOLA (1995)](/blog/2025/05/music-review-down-nola-1995-.html "Music review: Down - NOLA (1995)")

[Novel review: Glen Cook - Sweet Silver Blues (1987)](/blog/2025/05/novel-review-glen-cook-sweet-silver-blues-1987-.html "Novel review: Glen Cook - Sweet Silver Blues (1987)")

[Music review: diSEMBOWELMENT - Transcendence into the Peripheral (1993)](/blog/2025/05/music-review-disembowelment-transcendence-into-the-peripheral-1993-.html "Music review: diSEMBOWELMENT - Transcendence into the Peripheral (1993)")

[ ] [Novel review: S.M. Stirling - Under the Yoke (1989)](/blog/2025/05/novel-review-sm-stirling-under-the-yoke-1989-.html "Novel review: S.M. Stirling - Under the Yoke (1989)")

[The novel](/blog/2025/05/novel-review-sm-stirling-under-the-yoke-1989-.html#h2-0)

[The ideas](/blog/2025/05/novel-review-sm-stirling-under-the-yoke-1989-.html#h2-1)

[ ] 04

[Music review: Deathspell Omega - Si Monvmentvm Reqvires, Circvmspice (2004)](/blog/2025/04/music-review-deathspell-omega-si-monvmentvm-reqvires-circvmspice-2004-.html "Music review: Deathspell Omega - Si Monvmentvm Reqvires, Circvmspice (2004)")

[ ] [Ogg Vorbis cover art embedding: Tcl vs Common Lisp](/blog/2025/04/ogg-vorbis-cover-art-embedding-tcl-vs-common-lisp.html "Ogg Vorbis cover art embedding: Tcl vs Common Lisp")

[In Tcl](/blog/2025/04/ogg-vorbis-cover-art-embedding-tcl-vs-common-lisp.html#h2-0)

[In Common Lisp](/blog/2025/04/ogg-vorbis-cover-art-embedding-tcl-vs-common-lisp.html#h2-1)

[In MY Common Lisp](/blog/2025/04/ogg-vorbis-cover-art-embedding-tcl-vs-common-lisp.html#h2-2)

[ ] [Adding keyword parameters to Tcl procs](/blog/2025/04/adding-keyword-parameters-to-tcl-procs.html "Adding keyword parameters to Tcl procs")

[How it's made](/blog/2025/04/adding-keyword-parameters-to-tcl-procs.html#h2-0)

[Movie review: Ford v Ferrari (2019)](/blog/2025/04/movie-review-ford-v-ferrari-2019-.html "Movie review: Ford v Ferrari (2019)")

[Music review: Dead Can Dance - Within the Realm of a Dying Sun (1987)](/blog/2025/04/music-review-dead-can-dance-within-the-realm-of-a-dying-sun-1987-.html "Music review: Dead Can Dance - Within the Realm of a Dying Sun (1987)")

[Music review: Dark Tranquility - Skydancer (1993)](/blog/2025/04/music-review-dark-tranquility-skydancer-1993-.html "Music review: Dark Tranquility - Skydancer (1993)")

[ ] 03

[Music review: Darkthrone - Goatlord (1996)](/blog/2025/03/music-review-darkthrone-goatlord-1996-.html "Music review: Darkthrone - Goatlord (1996)")

[Music review: Danzig - Danzig II - Lucifuge (1990)](/blog/2025/03/music-review-danzig-danzig-ii-lucifuge-1990-.html "Music review: Danzig - Danzig II - Lucifuge (1990)")

[Music review: Crowbar - Crowbar (1993)](/blog/2025/03/music-review-crowbar-crowbar-1993-.html "Music review: Crowbar - Crowbar (1993)")

[Speeding up cljqalbum](/blog/2025/03/speeding-up-cljqalbum.html "Speeding up cljqalbum")

[Pruning Portage package config files](/blog/2025/03/pruning-portage-package-config-files.html "Pruning Portage package config files")

[Music review: Comus - First Utterance (1971)](/blog/2025/03/music-review-comus-first-utterance-1971-.html "Music review: Comus - First Utterance (1971)")

[Movie review: Idiocracy (2006)](/blog/2025/03/movie-review-idiocracy-2006-.html "Movie review: Idiocracy (2006)")

[A Common Lisp jq replacement](/blog/2025/03/a-common-lisp-jq-replacement.html "A Common Lisp jq replacement")

[Music review: Cocteau Twins - Heaven or Las Vegas (1990)](/blog/2025/03/music-review-cocteau-twins-heaven-or-las-vegas-1990-.html "Music review: Cocteau Twins - Heaven or Las Vegas (1990)")

[ ] 02

[Music review: Blut Aus Nord - Ultima Thulée (1995)](/blog/2025/02/music-review-blut-aus-nord-ultima-thulee-1995-.html "Music review: Blut Aus Nord - Ultima Thulée (1995)")

[ ] [Music questions challenge](/blog/2025/02/music-questions-challenge.html "Music questions challenge")

[What are five of your favorite albums?](/blog/2025/02/music-questions-challenge.html#h2-0)

[What are five of your favorite songs?](/blog/2025/02/music-questions-challenge.html#h2-1)

[Favorite instrument(s)?](/blog/2025/02/music-questions-challenge.html#h2-2)

[What song or album are you currently listening to?](/blog/2025/02/music-questions-challenge.html#h2-3)

[Do you listen to the radio? If so, how often?](/blog/2025/02/music-questions-challenge.html#h2-4)

[How often do you listen to music?](/blog/2025/02/music-questions-challenge.html#h2-5)

[How often do you discover music? And how do you discover music?](/blog/2025/02/music-questions-challenge.html#h2-6)

[What's a song or album that you enjoy that you wish had more recognition?](/blog/2025/02/music-questions-challenge.html#h2-7)

[What's your favorite song of all time?](/blog/2025/02/music-questions-challenge.html#h2-8)

[Has your taste in music evolved over the years?](/blog/2025/02/music-questions-challenge.html#h2-9)

[Music review: 椎名林檎 (Shiina Ringo) - 勝訴ストリップ (Shōso Strip) (2000)](/blog/2025/02/music-review-shiina-ringo-shouso-strip-2000-.html "Music review: 椎名林檎 (Shiina Ringo) - 勝訴ストリップ (Shōso Strip) (2000)")

[Linux pipe(2) vs ring buffer](/blog/2025/02/linux-pipe-2-vs-ring-buffer.html "Linux pipe(2) vs ring buffer")

[Novel review: Robert Heinlein - The Moon is a Harsh Mistress (1966)](/blog/2025/02/novel-review-robert-heinlein-the-moon-is-a-harsh-mistress-1966-.html "Novel review: Robert Heinlein - The Moon is a Harsh Mistress (1966)")

[Music review: Black Flag - My War (1984)](/blog/2025/02/music-review-black-flag-my-war-1984-.html "Music review: Black Flag - My War (1984)")

[ ] 01

[Music review: Belkètre - Ambre Zuèrkl Vuorhdrévarvtre (1996)](/blog/2025/01/music-review-belketre-ambre-zuerkl-vuorhdrevarvtre-1996-.html "Music review: Belkètre - Ambre Zuèrkl Vuorhdrévarvtre (1996)")

[Cooking recipe: bœuf bourguignon](/blog/2025/01/cooking-recipe-boeuf-bourguignon.html "Cooking recipe: bœuf bourguignon")

[Most memorable extreme music screaming](/blog/2025/01/most-memorable-extreme-music-screaming.html "Most memorable extreme music screaming")

[Music review: Amesoeurs - Ruines Humaines (2006)](/blog/2025/01/music-review-amesoeurs-ruines-humaines-2006-.html "Music review: Amesoeurs - Ruines Humaines (2006)")

[Novel review: Terry Pratchett - Mort (1987)](/blog/2025/01/novel-review-terry-pratchett-mort-1987-.html "Novel review: Terry Pratchett - Mort (1987)")

[Novel review: Mark Danielewski - House of Leaves (2000)](/blog/2025/01/novel-review-mark-danielewski-house-of-leaves-2000-.html "Novel review: Mark Danielewski - House of Leaves (2000)")

[PDF to CBZ for e-reader](/blog/2025/01/pdf-to-cbz-for-ereader.html "PDF to CBZ for e-reader")

[Music review: Acid Bath - Paegan Terrorism Tactics (1996)](/blog/2025/01/music-review-acid-bath-paegan-terrorism-tactics-1996-.html "Music review: Acid Bath - Paegan Terrorism Tactics (1996)")

[Video game review: Bloodstained: Ritual of the Night (2019)](/blog/2025/01/video-game-review-bloodstained-ritual-of-the-night-2019-.html "Video game review: Bloodstained: Ritual of the Night (2019)")

[Dotfiles management](/blog/2025/01/dotfiles-management.html "Dotfiles management")

[ ] 2024

[ ] 12

[Novel Review: Liu Cixin - The Three-Body Problem (2008)](/blog/2024/12/novel-review-liu-cixin-the-three-body-problem-2008-.html "Novel Review: Liu Cixin - The Three-Body Problem (2008)")

[GNU parallel out, pararun in](/blog/2024/12/parallel-out-pararun-in.html "GNU parallel out, pararun in")

[Advent of Code 2024: retrospective](/blog/2024/12/aoc2024-retrospective.html "Advent of Code 2024: retrospective")

[Advent of Code 2024: Day 01](/blog/2024/12/aoc2024.html "Advent of Code 2024: Day 01")

[ ] 11

[ ] [How I Learned to Stop Worrying and Love GC](/blog/2024/11/how-i-learned-to-stop-worrying-and-love-gc.html "How I Learned to Stop Worrying and Love GC")

[Initial C weenie stance](/blog/2024/11/how-i-learned-to-stop-worrying-and-love-gc.html#h2-0)

[Insights and updated views](/blog/2024/11/how-i-learned-to-stop-worrying-and-love-gc.html#h2-1)

[New stance](/blog/2024/11/how-i-learned-to-stop-worrying-and-love-gc.html#h2-2)

[See also](/blog/2024/11/how-i-learned-to-stop-worrying-and-love-gc.html#h2-3)

[Music review: Thee Maldoror Kollective - New Era Viral Order (Dogma Slaughterhouse and the Children of Anaemia) (2002)](/blog/2024/11/music-review-thee-maldoror-kollective-new-era-viral-order-2002-.html "Music review: Thee Maldoror Kollective - New Era Viral Order (Dogma Slaughterhouse and the Children of Anaemia) (2002)")

[Novel review: Terry Pratchett - Guards! Guards! (1989) & Men at Arms (1993)](/blog/2024/11/novel-review-terry-pratchett-guards-guards-1989-men-at-arms-1993-.html "Novel review: Terry Pratchett - Guards! Guards! (1989) & Men at Arms (1993)")

[ ] [Smuggling files under Google's nose](/blog/2024/11/smuggling-files-under-google-s-nose.html "Smuggling files under Google's nose")

[First blood: nested zips](/blog/2024/11/smuggling-files-under-google-s-nose.html#h2-0)

[Second skirmish: file signature doctoring](/blog/2024/11/smuggling-files-under-google-s-nose.html#h2-1)

[Final setback and victory](/blog/2024/11/smuggling-files-under-google-s-nose.html#h2-2)

[My archives](/blog/2024/11/my-archives.html "My archives")

[Emacs: separate minibuffer history for a command](/blog/2024/11/emacs-separate-minibuffer-history-for-command.html "Emacs: separate minibuffer history for a command")

[Music review: Techno Animal - The Brotherhood of the Bomb (2001)](/blog/2024/11/music-review-techno-animal-the-brotherhood-of-the-bomb-2001-.html "Music review: Techno Animal - The Brotherhood of the Bomb (2001)")

[CL iterate's COLLECT performance notice](/blog/2024/11/cl-iterate-collect-perf.html "CL iterate's COLLECT performance notice")

[ ] 10

[Music review: Burzum - Det som engang var (1993)](/blog/2024/10/music-review-burzum-det-som-engang-var-1993-.html "Music review: Burzum - Det som engang var (1993)")

[QoL addition to Common Lisp :start/:end](/blog/2024/10/qol-addition-to-common-lisp-start-end.html "QoL addition to Common Lisp :start/:end")

[ ] [Closures in Tcl](/blog/2024/10/tcl-closures.html "Closures in Tcl")

[What kind of closures](/blog/2024/10/tcl-closures.html#h2-0)

[In Tcl](/blog/2024/10/tcl-closures.html#h2-1)

[Music review: Abigor - Supreme Immortal Art (1998)](/blog/2024/10/music-review-abigor-supreme-immortal-art-1998-.html "Music review: Abigor - Supreme Immortal Art (1998)")

[git secret filter](/blog/2024/10/git-secret.html "git secret filter")

[ ] [My sfeed setup](/blog/2024/10/sfeed-setup.html "My sfeed setup")

[Introduction](/blog/2024/10/sfeed-setup.html#h2-0)

[Sfeed praise](/blog/2024/10/sfeed-setup.html#h2-1)

[Personal additions](/blog/2024/10/sfeed-setup.html#h2-2)

[ ] [Why I like Tcl](/blog/2024/10/why-tcl.html "Why I like Tcl")

[Pros](/blog/2024/10/why-tcl.html#h2-0)

[Cons](/blog/2024/10/why-tcl.html#h2-1)

[Conclusion](/blog/2024/10/why-tcl.html#h2-2)

[ ] 09

[Music review: Samael - Eternal (1999)](/blog/2024/09/music-review-samael-eternal-1999-.html "Music review: Samael - Eternal (1999)")

[Movie review: The Crow (1994)](/blog/2024/09/movie-review-the-crow-1994-.html "Movie review: The Crow (1994)")

[ ] [Bourne shell stdio trivia](/blog/2024/09/bourne-shell-stdio-trivia.html "Bourne shell stdio trivia")

[`while read` loops and interactive commands](/blog/2024/09/bourne-shell-stdio-trivia.html#h2-0)

[Default stream buffering](/blog/2024/09/bourne-shell-stdio-trivia.html#h2-1)

[ ] Tags

[action (1)](/blog/tags/action.html "action (1)")

[advent of code (2)](/blog/tags/advent-of-code.html "advent of code (2)")

[alternate history (1)](/blog/tags/alternate-history.html "alternate history (1)")

[anime review (4)](/blog/tags/anime-review.html "anime review (4)")

[black metal (8)](/blog/tags/black-metal.html "black metal (8)")

[blackgaze (1)](/blog/tags/blackgaze.html "blackgaze (1)")

[c (1)](/blog/tags/c.html "c (1)")

[comedy (3)](/blog/tags/comedy.html "comedy (3)")

[computer science (1)](/blog/tags/computer-science.html "computer science (1)")

[cooking recipe (1)](/blog/tags/cooking-recipe.html "cooking recipe (1)")

[crime drama (1)](/blog/tags/crime-drama.html "crime drama (1)")

[crust punk (1)](/blog/tags/crust-punk.html "crust punk (1)")

[darkwave (2)](/blog/tags/darkwave.html "darkwave (2)")

[death doom metal (2)](/blog/tags/death-doom-metal.html "death doom metal (2)")

[death metal (1)](/blog/tags/death-metal.html "death metal (1)")

[dotfiles (6)](/blog/tags/dotfiles.html "dotfiles (6)")

[dystopia (2)](/blog/tags/dystopia.html "dystopia (2)")

[emacs (2)](/blog/tags/emacs.html "emacs (2)")

[fantasy (6)](/blog/tags/fantasy.html "fantasy (6)")

[folk (1)](/blog/tags/folk.html "folk (1)")

[gentoo (2)](/blog/tags/gentoo.html "gentoo (2)")

[git (1)](/blog/tags/git.html "git (1)")

[gothic metal (2)](/blog/tags/gothic-metal.html "gothic metal (2)")

[graphics (1)](/blog/tags/graphics.html "graphics (1)")

[hacking (1)](/blog/tags/hacking.html "hacking (1)")

[heavy metal (1)](/blog/tags/heavy-metal.html "heavy metal (1)")

[hip hop (1)](/blog/tags/hip-hop.html "hip hop (1)")

[horror (4)](/blog/tags/horror.html "horror (4)")

[image processing (1)](/blog/tags/image-processing.html "image processing (1)")

[industrial metal (4)](/blog/tags/industrial-metal.html "industrial metal (4)")

[industrial rock (1)](/blog/tags/industrial-rock.html "industrial rock (1)")

[j-rock (1)](/blog/tags/j-rock.html "j-rock (1)")

[lisp (10)](/blog/tags/lisp.html "lisp (10)")

[melodic death metal (1)](/blog/tags/melodic-death-metal.html "melodic death metal (1)")

[meta (2)](/blog/tags/meta.html "meta (2)")

[movie review (11)](/blog/tags/movie-review.html "movie review (11)")

[music review (36)](/blog/tags/music-review.html "music review (36)")

[music (1)](/blog/tags/music.html "music (1)")

[novel review (14)](/blog/tags/novel-review.html "novel review (14)")

[performance (6)](/blog/tags/performance.html "performance (6)")

[personal (5)](/blog/tags/personal.html "personal (5)")

[post-punk (3)](/blog/tags/post-punk.html "post-punk (3)")

[programming (24)](/blog/tags/programming.html "programming (24)")

[punk (1)](/blog/tags/punk.html "punk (1)")

[sci-fi (9)](/blog/tags/sci-fi.html "sci-fi (9)")

[sh (8)](/blog/tags/sh.html "sh (8)")

[shoegaze (1)](/blog/tags/shoegaze.html "shoegaze (1)")

[sludge metal (5)](/blog/tags/sludge-metal.html "sludge metal (5)")

[stoner metal (2)](/blog/tags/stoner-metal.html "stoner metal (2)")

[surrealism (1)](/blog/tags/surrealism.html "surrealism (1)")

[synth pop (1)](/blog/tags/synth-pop.html "synth pop (1)")

[tcl (4)](/blog/tags/tcl.html "tcl (4)")

[thriller (2)](/blog/tags/thriller.html "thriller (2)")

[travel (1)](/blog/tags/travel.html "travel (1)")

[video game review (1)](/blog/tags/video-game-review.html "video game review (1)")

[ ] About

[Me](/about/me.html "Me")

[ ] [Website](/about/website.html "Website")

[*Raison d'être*](/about/website.html#h2-0)

[Design choices](/about/website.html#h2-1)

[Banners & Buttons](/about/website.html#h2-2)

[ ] Links

[ ] Webrings

[Lainring](/links/webrings/lainring.html "Lainring")

[Code](https://git.sr.ht/~q3cpma/)

# Fast SEQUENCE iteration in Common Lisp

Published on 2025-12-13

Tags: [programming](/blog/tags/programming.html), [lisp](/blog/tags/lisp.html), [performance](/blog/tags/performance.html)

---

## Introduction and code [§](#h2-0)

If you don't know what [`sequence`](https://www.lispworks.com/documentation/HyperSpec/Body/t_seq.htm#sequence)s are in CL, here's the gist of it: either a
linked [`list`](https://www.lispworks.com/documentation/HyperSpec/Body/t_list.htm) or a [`vector`](https://www.lispworks.com/documentation/HyperSpec/Body/t_vector.htm). The main idea being that some operations like element search, comparison or deletion should
have the same interface for both those types.

Basically, sequences are a band-aid over the lack of real iterator protocol (yes, even
considering the mildy supported [extensible sequences](https://shinmera.com/docs/trivial-extensible-sequences/) thing). But well, that's what we have to work with and it's not so bad really; we could be in
barren `C`-ountry after all.

One of the problems of sequences is that if you want to iterate over these while supporting the
conventional keywords (`:start`, `:end`, `:key`) without writing
entirely separate (and gnarly) versions, there are only two unified interfaces provided by ANSI:

1. [`elt`](https://www.lispworks.com/documentation/HyperSpec/Body/f_elt.htm#elt)+[`length`](https://www.lispworks.com/documentation/HyperSpec/Body/f_length.htm#length)+[`loop`](https://www.lispworks.com/documentation/HyperSpec/Body/m_loop.htm#loop) (or [`do`](https://www.lispworks.com/documentation/HyperSpec/Body/m_do_do.htm#do)): naïve and
   simple, what's actually used under the hood by `iterate`'s [`in-sequence`](https://iterate.common-lisp.dev/doc/Sequence-Iteration.html) driver. No free keyword forwarding and quadratic (thus extremely slow) on lists.
2. [`reduce`](https://www.lispworks.com/documentation/HyperSpec/Body/f_reduce.htm#reduce): way more practical as it handles all the keywords for you (even `:from-end`) and much faster since any non-toy implementation internally
   dispatches over the actual sequence type. Still not ideal as it has the overhead of repeat [`funcall`](https://www.lispworks.com/documentation/HyperSpec/Body/f_funcal.htm#funcall) of your closure and you don't have access to the often needed internal
   raw element (without `:key` applied) or iteration index.

So when I made a naïve [`max-elt`](https://git.sr.ht/~q3cpma/cl-utils/tree/d7322c018fc02f6657f84d150e1e5aa8b8693c2e/item/src/sequence.lisp#L172) (for this years' Advent of Code) then was *forced* to [rewrite](https://git.sr.ht/~q3cpma/cl-utils/tree/2a602b082ef8849d4f22e99fe1746a21a7564250/item/src/sequence.lisp#L170) it to use `reduce`, I said to myself "I must build that Lovecraftian macro
to handle the required nested monomorphization/specialization"… so here's the beast:

```
;; Support :FROM-END ? Would add yet another level of specialization though...
(defmacro do-sequence ((var seq &key (start 0) end key with-index with-raw-elt) &body body)
  "Iterate on a sequence with the usual keywords available. :WITH-INDEX (resp. :WITH-RAW-ELT)
takes an unevaluated symbol to use as index (resp. element without :KEY applied).

NB: since iteration is done via `(LOOP ... :DO (LOCALLY ,@BODY)), said body can use RETURN and
contain declarations."
  (once-only (seq start end key)
    (macrolet ((impl (type has-key-p &optional has-end-p)
                 `(let ((ivar (or with-index (gensym "IDX")))
                        (rvar (cond (with-raw-elt     with-raw-elt)
                                    (,(not has-key-p) var)
                                    (t                (gensym "RAW")))))
                    `(loop
                       ,@(ecase ,type
                           (list
                            `(,@(when (or ,has-end-p with-index)
                                  `(:for ,ivar :of-type (integer 0 #.array-dimension-limit)
                                    :from ,start ,@(when ,has-end-p `(:below ,end))))
                              :for ,rvar :in (nthcdr ,start ,seq)))
                           (vector
                            `(:for ,ivar :of-type (integer 0 #.array-dimension-limit)
                              :from ,start :below (or ,end (length ,seq))
                              :for ,rvar := (aref ,seq ,ivar))))
                       ,@(cond (,has-key-p   `(:for ,var := (funcall ,key ,rvar)))
                               (with-raw-elt `(:for ,var := ,rvar)))
                       :do (locally ,@body)))))
      `(etypecase ,seq
         (list
          (cond ((and ,key ,end) ,(impl 'list t   t))
                (,key            ,(impl 'list t   nil))
                (,end            ,(impl 'list nil t))
                (t               ,(impl 'list nil nil))))
         ((simple-array * (*)) ;; Same impl. as VECTOR, monomorphize for performance
          (if ,key
              ,(impl 'vector t)
              ,(impl 'vector nil)))
         (vector
          (if ,key
              ,(impl 'vector t)
              ,(impl 'vector nil)))))))
```

Except for the *de facto* standard `once-only` macro, it is ANSI CL
compliant. You can copy it under the Zlib license, if you wish so.

## Benchmarks [§](#h2-1)

Now, for some benchmarks! Here I compare the aforementioned `max-elt` core loop
written with `reduce` then with `do-sequence` against large sequences of
different types; needing both the index and raw element somewhat complicates the result and
illustrate why I included `:with-index` and `:with-raw-elt`.

```
(deftype index () `(integer 0 ,array-dimension-limit))
(deftype end ()   '(or null index))
(deftype key ()   '(or symbol (function (t) t) null))
(deftype test ()  '(or symbol (function (t t) t)))

(declaim (ftype (function (sequence test &key (:start index) (:end end) (:key key))
                          (values t (or null index)))
                max-elt-reduce max-elt-do-seq))

(defun max-elt-reduce (seq pred &key (start 0) end key)
  (let ((i start) maxi max)
    (declare (type index i))
    (reduce (if key ;; Hoist NIL key checking
                (lambda (kmax el)
                  (incf i)
                  (let ((kel (funcall key el)))
                    (if (or (= i start) (funcall pred kel kmax))
                        (progn (setf maxi i max el) kel)
                        kmax)))
                (lambda (kmax el)
                  (incf i)
                  (if (or (= i start) (funcall pred el kmax))
                      (progn (setf maxi i max el) el)
                      kmax)))
            seq :start start :end end)
    (values max maxi)))

(defun max-elt-do-seq (seq pred &key (start 0) end key)
  (let (maxi rmax max)
    (do-sequence (el seq :start start :end end :key key :with-index i :with-raw-elt r)
      (when (or (= i start) (funcall pred el max))
        (setf maxi i rmax r max el)))
    (values rmax maxi)))

(defconstant +len+ 5000000)

(let ((l   (make-sequence 'list   +len+ :initial-element 0))
      (sv  (make-sequence 'vector +len+ :initial-element 0))
      (fsv (make-array +len+ :element-type 'fixnum :initial-element 0))
      (fv  (make-array +len+ :element-type 'fixnum :initial-element 0 :adjustable t)))
  (format t "Test,~A~%" (lisp-implementation-type))
  (loop :for (args name) :in
        `(((,l   ,#'>) "LIST")
          ((,l   ,#'> :start 100 :end ,(- +len+ 100) :key ,#'1+) "LIST (fiddly)")
          ((,sv  ,#'>) "SIMPLE-VECTOR")
          ((,fsv ,#'>) "(SIMPLE-ARRAY FIXNUM)")
          ((,fv  ,#'>) "(VECTOR FIXNUM)"))
        :do (let ((tref (nth-value 1 (measure (apply #'max-elt-reduce args))))
                  (tnew (nth-value 1 (measure (apply #'max-elt-do-seq args)))))
              (format t "~A,~D → ~D (~@D%)~%"
                      name
                      (round (* tref 1000))
                      (round (* tnew 1000))
                      (round (* 100 (- (/ tref tnew) 1)))))))
```

And here are the results on some popular implementations (durations in ms):

| Test | SBCL | CCL | ECL | CLISP |
| --- | --- | --- | --- | --- |
| LIST | 39 → 26 (+50%) | 124 → 64 (+93%) | 979 → 499 (+96%) | 372 → 251 (+48%) |
| LIST (fiddly) | 46 → 39 (+18%) | 129 → 77 (+69%) | 1186 → 703 (+69%) | 450 → 408 (+10%) |
| SIMPLE-VECTOR | 44 → 32 (+38%) | 140 → 81 (+71%) | 966 → 600 (+61%) | 417 → 314 (+33%) |
| (SIMPLE-ARRAY FIXNUM) | 44 → 31 (+42%) | 141 → 81 (+73%) | 954 → 608 (+57%) | 417 → 315 (+32%) |
| (VECTOR FIXNUM) | 51 → 37 (+38%) | 177 → 121 (+46%) | 960 → 635 (+51%) | 422 → 331 (+27%) |

And another, simpler case (`position-all`, you can guess what it does) to exercise
compilers a bit differently:

Code

```
(deftype queue () '(cons cons list))
(defun make-queue ()
  (let ((q (cons nil nil)))
    (setf (car q) q)
    q))

(declaim (ftype (function (t queue) queue) push-queue)
         (inline push-queue))
(defun push-queue (obj queue)
  (let ((new-tail (list obj)))
    (setf (cdar queue) new-tail
          (car queue)  new-tail))
  queue)

(deftype index () `(integer 0 ,array-dimension-limit))
(deftype end ()   '(or null index))
(deftype key ()   '(or symbol (function (t) t) null))
(deftype test ()  '(or symbol (function (t t) t)))

(declaim (ftype (function (t sequence &key (:start index) (:end end) (:key key) (:test test))
                          list)
                position-all-reduce position-all-do-seq))

(defun position-all-reduce (obj seq &key (start 0) end key (test #'eql))
  (let ((i start))
    (declare (type index i))
    (cdr
     (reduce (if key ;; Hoist NIL key checking
                 (lambda (acc el)
                   (incf i)
                   (when (funcall test (funcall key el) obj)
                     (push-queue i acc))
                   acc)
                 (lambda (acc el)
                   (incf i)
                   (when (funcall test el obj)
                     (push-queue i acc))
                   acc))
             seq :start start :end end :initial-value (make-queue)))))

(defun position-all-do-seq (obj seq &key (start 0) end key (test #'eql))
  (let ((acc (make-queue)))
    (do-sequence (el seq :start start :end end :key key :with-index i)
      (when (funcall test el obj)
        (push-queue i acc)))
    (cdr acc)))

(defconstant +len+ 5000000)

(let* ((sv  (let ((tmp (make-sequence 'vector +len+ :initial-element 0)))
              (loop :for i :from 0 :below +len+ :by 1000
                    :do (setf (aref tmp i) 42))
              tmp))
       (l   (coerce sv 'list))
       (fsv (make-array +len+ :element-type 'fixnum :initial-contents l))
       (fv  (make-array +len+ :element-type 'fixnum :initial-contents l :adjustable t)))
  (format t "Test,~A~%" (lisp-implementation-type))
  (loop :for (args name) :in
        `(((42   ,l) "LIST")
          ((42   ,l :start 100 :end ,(- +len+ 100) :key ,#'1+) "LIST (fiddly)")
          ((42  ,sv) "SIMPLE-VECTOR")
          ((42 ,fsv) "(SIMPLE-ARRAY FIXNUM)")
          ((42  ,fv) "(VECTOR FIXNUM)"))
        :do (let ((tref (nth-value 1 (measure (apply #'position-all-reduce args))))
                  (tnew (nth-value 1 (measure (apply #'position-all-do-seq args)))))
              (format t "~A,~D → ~D (~@D%)~%"
                      name
                      (round (* tref 1000))
                      (round (* tnew 1000))
                      (round (* 100 (- (/ tref tnew) 1)))))))
```

| Test | SBCL | CCL | ECL | CLISP |
| --- | --- | --- | --- | --- |
| LIST | 30 → 11 (+173%) | 58 → 18 (+224%) | 879 → 351 (+150%) | 291 → 147 (+98%) |
| LIST (fiddly) | 33 → 21 (+57%) | 63 → 28 (+122%) | 907 → 538 (+69%) | 352 → 301 (+17%) |
| SIMPLE-VECTOR | 29 → 20 (+45%) | 70 → 33 (+110%) | 826 → 458 (+80%) | 310 → 220 (+41%) |
| (SIMPLE-ARRAY FIXNUM) | 29 → 21 (+38%) | 71 → 35 (+106%) | 855 → 477 (+79%) | 314 → 219 (+43%) |
| (VECTOR FIXNUM) | 40 → 26 (+54%) | 108 → 70 (+54%) | 835 → 468 (+78%) | 321 → 228 (+41%) |

*Benchmarking details*

* Versions used: SBCL 2.5.11, CCL 1.13, ECL 24.5.10, CLISP 2.49.92 (bytecode compiler used)
* Hardware: AMD 5900X, 64 GB DDR4
* Software: Gentoo Linux, linux 6.12, gcc 15.2, glibc 2.41
* Misc.: [`optimize`](https://www.lispworks.com/documentation/HyperSpec/Body/d_optimi.htm#optimize) was set to `(speed 3) (safety 0) (debug 0)` for
  the sake of benchmarking, speedups are comparable without. `measure` does a full GC
  before starting its timer.

## Conclusion [§](#h2-2)

Well, isn't that welcome? Both the performance and readability gains were worth the effort, in
my opinion; especially outside of SBCL which seems to have a particularly well optimized `reduce`.

Beware code bloat and compilation slowdown though, such deep specialization with `loop` macros as leaves isn't free; so don't inline unless you intend on exploiting
your compiler's DCE pass.

Made with [![Emacs](/resources/logos/emacs.svg)](https://www.gnu.org/software/emacs/), [![LISP](/resources/logos/lisp.svg)](https://common-lisp.net/) and [spinneret](https://github.com/ruricolist/spinneret), served by [![Caddy](/resources/logos/caddy.svg)](https://github.com/caddyserver/caddy)Generated by [make-website](https://git.sr.ht/~q3cpma/make-website) Wed, 17 Dec 2025 22:39:45 +0000
